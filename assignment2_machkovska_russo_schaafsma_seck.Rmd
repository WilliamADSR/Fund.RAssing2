---
title: "Logistic regression assignment, group 3"  
author: Elizabeth Machkovska, Letícia Marçal Russo, Madio Seck, William Schaafsma 
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
       highlight: textmate
       theme: flatly
       number_sections: yes
       toc: yes
       toc_float:
         collapsed: yes
         smooth_scroll: no
---

# Context 

# Packages
```{r libraries, warning = FALSE, message = FALSE}
library(ggplot2)
library(GGally)
library(readr)
library(dbplyr)
library(tidyverse)
library(magrittr)
library(lattice)
library(correlation)
library(ggcorrplot)
library(see)
library(caret)
library(psych)
```

# Research question and relevance 


# Loading the Dataset
The data set is derived from Kaggle and is uploaded by fedesoriano (2021). With the following script a distinction is made between continuous (numeric) and categorical variables which are transformed to factor type data. 
```{r}
heart <- read_csv("heart.csv", 
                  col_types = cols(Age = col_number(),
                                   Sex = col_factor(),
                                   ChestPainType = col_factor(),
                                   RestingBP = col_number(),
                                   Cholesterol = col_number(), 
                                   FastingBS = col_factor(), 
                                   RestingECG = col_factor(),
                                   MaxHR = col_number(),
                                   ExerciseAngina = col_factor(),
                                   Oldpeak = col_number(),
                                   ST_Slope = col_factor(), 
                                   HeartDisease = col_factor()
                   )
                  )
heart$FastingBS <- factor(heart$FastingBS,
                                labels = c("B120", "A120"))
heart$HeartDisease <- factor(heart$HeartDisease,
                                labels = c("Norm", "Prob"))
```

# Explanation of the variables

This data set holds 12 variables of which HeartDisease is our dichotomous outcome variable. A futher elaboration on the variables follows:

**Variable 1**: *Age*. It's a numeric variable of the patients' age expressed in years.  
  

**Variable 2**: *Sex*. It's a categorical variable which holds the groups: F = female & M = male.  
  

**Variable 3**: *ChestPaintype*. It's a categorical variable which contains 4 different types of chest pains.  

*TA*: Typical Angina, a type of chest pain caused by reduced blood flow to the heart.  

*ATA*: Atypical Angina, a type of chest pain that doesn't meet the criteria for angina.  

*NAP*: Non-Anginal Pain, a type of chest pain that is not caused by heart disease or a heart attack. 

*ASY*: Asymptomatic, a type of chest pain that includes no chest pain but there is angina.  


**Variable 4**: *RestingBP*. It's a numeric variable representing patients' resting blood pressure (mmHg). The average blood pressure for an adult male is 120/80 mmHg. Average blood pressure increases when people get older. Furthermore, women's average blood pressure is mostly a little bit lower compared to males. A resting blood pressure > 140 is considered high and may cause heart failure.  


**Variable 5**: *Cholesterol*. It's a numeric variable representing patients' cholesterol levels (mm / dl). A healthy adult has a cholesterol level lower than 200 mm / dl. High cholesterol levels (> 240) is moderate/high and therefore may cause heart failure.  


**Variable 6**: *FastingBS*. It's a dichotomous variable representing patients' fasting blood sugar (mg / dl). Fasting blood sugar levels > 120 mg / dl are coded as a 1. Fasting blood sugar levels < 120 mg / dl are coded as a 0. High levels of blood sugar infer diabetes which may cause heart failure.   


**Variable 7**: *RestingECG*. It's a categorical variable which contains 3 different types of electric activity in the heart.  

*Normal*: The heart is beating in a regular sinus rhythm at a normal pace. No danger whatsoever.   

*ST*: Indicates an abnormality in the heartbeat. It is associated with increased cardiovascular risk.  

*LVH*: This activity in the heart represents valve problems which increasingly thickens the wall of the heart's main pumping chamber. It's the most common cause of high blood pressure which may cause heart failure.  


**Variable 8**: *MaxHR*.  


**Variable 9**: *Exercise Angina*.  


**Variable 10**: *Oldpeak*.  


**Variable 11**: *ST_slope*.  


**Variable 12**: *HeartDisease*.  

# Inspecting the dataset and cleaning up

```{r} 
head(heart) %>% 
  knitr::kable(format = "markdown", digits= 1, padding = 30, align = 'c')
```
Comment here. 

```{r}
summary(heart)
```
Comment here

```{r}
str(heart)
```

## Exluding Missing values (cholesterol)

Comment here.

```{r}
Clean_Heart <- heart[-c(294:416, 422, 
                        424:425, 428:431, 
                        435:443, 536:537, 
                        519, 515:516, 509, 
                        493, 484:485, 480:482,
                        478, 475:476, 471:473,
                        467:468, 464:465,
                        462, 456:460, 450:452,
                        454, 447), ]
```

# Descriptive analysis

Comment here.

```{r}
Hist_age <- hist(Clean_Heart$Age)
```

This is not working. Check why.
```{r}
#Box_age <- boxplot(Clean_Heart$Age) + title(main = "Distribution of age", ylab = "Age in years")
```

Comment here.

```{r}
median(Clean_Heart$Age)
```

Age is distributed normally. The youngest observations is 28 years old and the oldest observation is 77 years old. The median of this data set is 54.

```{r}
Hist1_chol <- hist(heart$Cholesterol)
```

The Cholesterol variable has 172 observations of the number 0. This means there are 172 patients without data on cholesterol levels. Therefore these observations will be exluded from the dataset since a value of 0 on cholesterol levels is impossible. 

```{r}
Hist2_chol <- hist(Clean_Heart$Cholesterol)
```

Comment here.

```{r}
#Box_chol <- boxplot(Clean_Heart$Cholesterol) 
#            + title(main = "Distribution of cholesterol levels", 
#                    ylab = "Cholesterol levels (mm / dl)")
```
Comment here.

```{r}
min(Clean_Heart$Cholesterol)
max(Clean_Heart$Cholesterol)
median(Clean_Heart$Cholesterol)
```

Here we see that the distribution of cholesterol levels has several outliers. The median is a cholesterol level of 237 which is within the range of a healthy level. a The lowest level of cholesterol is 85 and the highest level of cholesterol is 603. When checking assumptions we will see whether we need to exclude more observations due to abnormal cholesterol levels.

```{r}
Hist_BPrest <- hist(Clean_Heart$RestingBP)
```

Comment here.

```{r}
#Box_BPrest <- boxplot(Clean_Heart$RestingBP) 
#                 + title(main = "Distribution of resting blood pressure levels", 
#                         ylab = "Resting blood pressure levels (mmHg)")
```

Comment here.

```{r}
median(Clean_Heart$RestingBP)

max(Clean_Heart$RestingBP)
```

Most of the observations have a healthy resting blood pressure, which the median of 130 also represents. There are some outliers past the maximum of the boxplot, the highest observations has a resting blood pressure of 200 which is very dangerous.

#Split the data into training and test samples
In the training data set 80% (p=0.8) of the rows were generated as a new sample. Out of 597 observations 52% has normal heart performance (312 rows) and 48% has heart problems (285 rows). Therefore, the training data has approximately equal distribution of classes within response variable. 
```{r}
set.seed(42)
trainDataIndex <- createDataPartition(Clean_Heart$HeartDisease, p=0.8, list = FALSE)  
train_heart <- Clean_Heart[trainDataIndex, ]
test_heart <- Clean_Heart[-trainDataIndex, ]

table(train_heart$HeartDisease)
```

# Correlation 

The **easystats** package by Makowski and his colleagues (2019) is used to create the pairwise correlation matrix. The long variable names are first shortened to make visualization neater. 
```{r}
train_heart$CPT <- train_heart$ChestPainType
train_heart$R_BP <- train_heart$RestingBP
train_heart$Chol <- train_heart$Cholesterol
train_heart$F_BP <- train_heart$FastingBS
train_heart$R_ECG <- train_heart$RestingECG
train_heart$E_A <- train_heart$ExerciseAngina
train_heart$O_P <- train_heart$Oldpeak
train_heart$ST_S <- train_heart$ST_Slope
train_heart$H_D <- train_heart$HeartDisease

train_select <- select(train_heart, c(1, 2, 8, 13:21))
```

This function allows to use different methods, including correlation between factors. 
```{r, message=FALSE, eval=FALSE}

cor <- correlation(train_select, include_factors = TRUE, method = "auto")

cor %>%
  summary() %>%
  plot(show_labels=TRUE,
       show_p=TRUE,
       size_point=5,
       size_text=5,
       digits=2,
       type="tile",
       )
```

![The full correlation matrix](D:/JAAR 4/ADS1/Fund.RAssing2/correlation_matrix.png) 

Three methods of calculating the correlation coefficient were used, as seen in the ![image](D:/JAAR 4/ADS1/Fund.RAssing2/example_cor.png)

```{r}
#cor[59:69, ]
```

Those methods are

1. Point-biserial correlation

2. Pearson correlation

3. Tetrachoric correlation
In the case of tetrachorics, when both observed variables are dichotomous, cells with zero counts are replaced with 0.5 as a correction for continuity.

The next figures provide a close up of the correlation coefficients between pairs of variables.

Correlation between continuous predictor variables and dichotomous categorical outcome variable is calculated using the *Point-biserial* correlation. The relationship between continuous predictors is measured using *Pearson*. 
```{r, message=FALSE}
train_select %>%
  select(Age, R_BP, Chol, MaxHR, O_P, H_D) %>% 
  correlation(include_factors = TRUE, method = "auto") %>%
  summary() %>%
    plot(show_labels=TRUE,
       show_p=TRUE,
       size_point=5,
       size_text=4,
       digits=2,
       type="tile",
       )
```

When comparing the coefficients for the observations of patients with a heart disease (*H_D.Prob*), in order from strongest to weakest association, there is a significant strong positive relationship between oldpeak, which means that the higher the value of *O_P*, the more often a heart problem occurs. Relationship between *MaxHR* and heart disease is moderately negative, which suggests that the higher the maximum heart rate achieved the less heart problems are observed. Both *Oldpeak* and *MaxHR* have a moderate strength of a relationship with *Age*. In turn, *Age* has a moderate positive relationship with heart problems, meaning that the older the patients observed, the more often they have a heart disease detected. Association between resting blood pressure (*R_BP*) is weak and positive. The relationships have a reverse direction when comparing the values for a normal heart (*H_D.Norm*). 
From continuous predictor variables the values of cholesterol (*Chol*) have insignificant negligible association with both the heart disease and other numeric predictors. 

*Tetrachoric* correlation is a measure of the correlation between a pair of dichotomous variables. The coefficient is calculated for each separate class of a categorical variable.
```{r, message=FALSE}
train_select %>%
  select(CPT, R_ECG, ST_S, H_D) %>% 
  correlation(include_factors = TRUE, method = "auto") %>%
  summary() %>%
    plot(show_labels=TRUE,
       show_p=TRUE,
       size_point=2,
       size_text=3,
       digits=2,
       type="tile",
       )
```

For the categories of the slope of peak exercise (*ST_S*) there is a very strong negative association between up slopping peaks in contrast to the (very) strong positive relationship of the flattening and downwards slopes in relation to the number heart diseases observed.Three out of four chest pain types (*CPT*) have a negative relationship with heart problems variable varying from strong (*CPT.ATA*) to moderate (*CPT.NAP*) to weak, whereas asymptomatic CPT (*CPT.ASY*) has a very strong positive relationship. Association with *CPT.TA* is less significant (and is relatively weak) compared to the other chest pain types. Out of three types of resting ECG results (*R_ECG*) normal results (*Normal*) have negative relationship with the heart problems, whereas the 'abnormal' ones have a positive relationship with heart problems. In case of more normal observations of *R_ECG*, there are less heart diseases observed. 

The correlation matrix per binary predictor and outcome variables is visualized in the ![image](D:/JAAR 4/ADS1/Fund.RAssing2/cor_matrix_binary.png)

```{r, message=FALSE}
train_select %>%
  select(Sex, F_BP, E_A, H_D) %>% 
  correlation(include_factors = TRUE, method = "auto") %>%
  summary() %>%
    plot(show_labels=TRUE,
       show_p=TRUE,
       size_point=4,
       size_text=4,
       digits=2,
       type="tile",
       )
```

The observations of angina induced by exercise (*E_A.Y*) correlate strongly and positively with the heart disease. Fasting blood sugar above 120 mg/dl (*F_BP.A120*) has a moderate positive relationship with the outcome variable. Gender (*Sex*) seems to have a strong relationship with the heart disease observations, however, interpretation of direction of this association is not meaningful. 

!!!To find the importance of a categorical variable, instead of correlation looking at how often a heart disease is detected per category. Compared to correlation matrices, types which have heart disease more often have a strong relationship coefficient. 
```{r}
barplot(table(train_heart$HeartDisease, train_heart$Sex), col = c("green","red"))
legend("topright", c("Normal","Problem"), fill = c("green","red"))
```
In this data set men have heart problems more often than women. 

```{r}
barplot(table(train_heart$HeartDisease, train_heart$ChestPainType), col = c("green","red"))
legend("topright", c("Normal","Problem"), fill = c("green","red"))
```
In this data set asymptomatic chest pain type has relatively more cases which have heart concerns. 

```{r}
barplot(table(train_heart$HeartDisease, train_heart$FastingBS), col = c("green","red"))
legend("topright", c("Normal","Problem"), fill = c("green","red"))
```
Patients with blood sugar above 120 mg/dl have heart disease relatively more often then not. 
However, blood sugar below 120 mg/dl has relatively small difference between the diagnosis
. This is reflected in moderate relationship coefficient. 

```{r}
barplot(table(train_heart$HeartDisease, train_heart$RestingECG), col = c("green","red"))
legend("topright", c("Normal","Problem"), fill = c("green","red"))
```
ST and LVH results have relatively more cases with heart problems diagnosed. This variable has a weak relationship with the outcome. 

```{r}
barplot(table(train_heart$HeartDisease, train_heart$ExerciseAngina), col = c("green","red"))
legend("topright", c("Normal","Problem"), fill = c("green","red"))
```

Patients with angina induced by exercise have heart disease more often. 

```{r}
barplot(table(train_heart$HeartDisease, train_heart$ST_Slope), col = c("green","red"))
legend("topright", c("Normal","Problem"), fill = c("green","red"))
```

The number of patients with heart problems is largest for cases with the flat and down slopes observed.

# Set seed
Setting seed to generate a reproducible result.
```{r }
set.seed(42)

```

# Model building

Comment here.

```{r}
#Model1 <- glm(HeartDisease ~ Cholesterol, 
#              data = Clean_heart, 
#              family = "binomial")
```

Comment here.

```{r}
#summary(Model1)
```

# Best model

# Comparing models

# Cross Validation

# Confusion Matrix

# Visualization of the model 

# Checking assumptions 

## Residuals vs Fitted model

## Normal Q-Q plot

## Scale-Location 

## Cook's distance

## Residuals vs Leverage

# Interpreting the final model

# Answering the research question 

# Discussion & Limitations


# Sources
fedesoriano. (2021, September). *Heart Failure Prediction Dataset.* [Data set] Retrieved from https://www.kaggle.com/fedesoriano/heart-failure-prediction.

Hastie, T., James, G., Tibshirani, R. & Witten, D. (2021). *An Introduction to Statistical Learning with Applications in R*. (2nd edition). Springer. Retrieved from https://hastie.su.domains/ISLR2/ISLRv2_website.pdf

Haira, K. (2018, 17 May). *dplyr - advanced-joining* Retrieved from https://rpubs.com/KunalHaria/390063.

Kassambara, A. (2018). Linear Regression Assumptions and Diagnostics in R: Essentials. In: *Statistical Tools for High-Throughput Data Analysis.* (1st edition). Retrieved from http://www.sthda.com/english/articles/39-regression-model-diagnostics/161-linear-regression-assumptions-and-diagnostics-in-r-essentials/#diagnostic-plots.

Klein, A. G., Gerhard, C., Büchner, R. D., Diestel, S. & Schermelleh-Engel, K. (2016). The detection of heteroscedasticity in regression models for psychological data. *Psychological Test and Assessment Modeling, 58*(4), 542-568.

Makowski, D., Ben-Shachar, M. S., Patil, I., & Lüdecke, D. (2019). Methods and Algorithms for Correlation Analysis in R. *Journal of Open Source Software, 5*(51), 2306. https://doi.org/10.21105/joss.02306

Rousselet, G. A., & Wilcox, R. R. (2020). Reaction times and other skewed distributions: problems with the mean and the median. *Meta-Psychology, 4*. 
https://doi.org/10.15626/MP.2019.1630




